---
title: "Atwaters siRNA Analysis"
output: html_document
date: '`r Sys.Date()`'
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r setup}
library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library("DT")
library("d3heatmap")
library("plotly")

source("WellPlateFunctions.R")

cDT <- fread("AtwatersCell_v1.0.txt",showProgress=FALSE)
cDT$OmeroDetailURL <- paste0('<a href="https://omero.ohsu.edu/webclient/img_detail/',cDT$ImageID,'/"',' target="_blank">Omero</a>')
  cDT$OmeroThumbnailURL <- paste0('<a href="https://omero.ohsu.edu/webclient/render_thumbnail/',cDT$ImageID,'/"',' target="_blank">Omero</a>')
  cDT$OmeroImageURL <- paste0('<a href="https://omero.ohsu.edu/webclient/render_image/',cDT$ImageID,'/"',' target="_blank">Omero</a>')
wDT <- fread("AtwatersWell_v1.0.txt")
wDT$OmeroDetailURL <- paste0('<a href="https://omero.ohsu.edu/webclient/img_detail/',wDT$ImageID,'/"',' target="_blank">Omero</a>')
  wDT$OmeroThumbnailURL <- paste0('<a href="https://omero.ohsu.edu/webclient/render_thumbnail/',wDT$ImageID,'/"',' target="_blank">Omero</a>')
  wDT$OmeroImageURL <- paste0('<a href="https://omero.ohsu.edu/webclient/render_image/',wDT$ImageID,'/"',' target="_blank">Omero</a>')

repDT <- fread("AtwatersRep_v1.0.txt")
barcodes <- unique(repDT$Barcode)

```


```{r WCC_byCellLine, fig.width=8,fig.height=5, eval=TRUE}
dt <- wDT[wDT$GeneSymbol %in% c("NegCtrl","CSCtrlA","CSCtrlB","CSCtrlC","CSCtrlD"),]
p <- ggplot(dt, aes(x=GeneSymbol, y=WellCellCount, colour=Barcode))+geom_boxplot()+
  ggtitle("Cell Count in Cell Seeding and NegCtrl Wells")+
  facet_wrap(~CellLine, scales = "free_y")+
  guides(colour=guide_legend(ncol=2))+
  theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

```

```{r UnivariateSignals , fig.width=5,fig.height=6, eval=TRUE}

DT <- cDT[grepl("NegCtrl",cDT$GeneSymbol)]
p <- ggplot(DT, aes(x=TotalIntensityDAPI,fill=factor(DNA2N,labels=c("2N","4N")),colour=factor(DNA2N,labels=c("2N","4N"))))+
  geom_histogram(binwidth=1000, position="dodge")+
  coord_cartesian(xlim=quantile(DT$TotalIntensityDAPI,c(.02,.99)))+
  ggtitle("Total DAPI Distribution in Negative Control Wells")+
  facet_grid(CellLine~Plate, scales = "free_y",labeller = labeller(Plate = label_both, CellLine = label_value))+
  guides(fill=guide_legend("DNA 2N or 4N"),colour=FALSE)+
  theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
print(p)

p <- ggplot(DT, aes(x=log2(MeanIntensityAlexa488Cyto+1)))+
  geom_histogram(binwidth=.01)+
  xlab("Mean Intensity KRT5 (logged)")+
  ggtitle("KRT5 Distribution")+
  facet_grid(CellLine~Plate,labeller = labeller(Plate = label_both, CellLine = label_value))+
  theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
print(p)

p <- ggplot(DT, aes(x=log2(MeanIntensityAlexa555Cyto+1)))+
  geom_histogram(binwidth=.01)+
  #coord_cartesian(xlim=quantile(DT$MeanIntensityAlexa555Cyto,c(.02,.97)))+
  xlab("Mean Intensity KRT19 (logged)")+
  ggtitle("KRT19 Distribution (logged)")+
  facet_grid(CellLine~Plate,labeller = labeller(Plate = label_both, CellLine = label_value))+
  theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
print(p)

p <- ggplot(DT, aes(x=log2(MeanIntensityAlexa647+1)))+
  geom_histogram(binwidth=.01)+
  xlab("Mean Intensity EdU (logged)")+
  ggtitle("EdU Distribution (logged)")+
  facet_grid(CellLine~Plate,labeller = labeller(Plate = label_both, CellLine = label_value))+
  theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
print(p)


```


```{r replicate_WCC_byBarcode, fig.width=8,fig.height=3.5, eval=TRUE}

for (barcode in barcodes){
  #cellLine <- strsplit(barcode,"_")[[1]][3]
  setkey(repDT,Barcode)
  DT <- repDT[barcode]
  seWCCN <- wDT[,list(se=sd(WellCellCountNorm)/sqrt(.N)), by=GeneSymbol]
  DT <- merge(DT,seWCCN,by="GeneSymbol")
  p <- ggplot(DT, aes(x=factor(relevel(reorder(GeneSymbol, WellCellCountNorm, FUN=median),ref="NegCtrl")), y=WellCellCountNorm))+    
    geom_bar(stat="identity", fill="gray30")+ 
    geom_errorbar(aes(ymax=WellCellCountNorm+se, ymin=WellCellCountNorm-se),position="dodge", width=0.25)+
    geom_hline(yintercept=1, colour="blue")+
    ggtitle(paste("Median Replicate Nuclei Count Normalized to NegCtrl in",barcode))+
    xlab("")+ylab("")+
    facet_grid(CellLine~Barcode, scales="free")+
    theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.6)),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  print(p)
}

```


```{r lineageRatio_byBarcode, fig.width=8,fig.height=3.5, eval=TRUE}

for (barcode in barcodes){
  #cellLine <- strsplit(barcode,"_")[[1]][3]
  setkey(repDT,Barcode)
  DT <- repDT[barcode]
  seLR <- wDT[,list(se=sd(LineageRatioNorm)/sqrt(.N)), by=GeneSymbol]
  DT <- merge(DT,seLR,by="GeneSymbol")
  p <- ggplot(DT, aes(x=factor(relevel(reorder(GeneSymbol, LineageRatioNorm, FUN=median),ref="NegCtrl")), y=LineageRatioNorm))+    
    geom_bar(stat="identity", fill="gray30")+ 
    geom_errorbar(aes(ymax=LineageRatioNorm+se, ymin=LineageRatioNorm-se),position="dodge", width=0.25)+
    #geom_hline(yintercept=1, colour="blue")+
    ggtitle(paste("Lineage Ratio Normalized to NegCtrl in",barcode))+
    xlab("")+ylab("")+
    facet_grid(CellLine~Barcode, scales="free")+
    theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.6)),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  print(p)
}

```


```{r Edu_byBarcode, fig.width=8,fig.height=3.5, eval=TRUE}

for (barcode in barcodes){
  #cellLine <- strsplit(barcode,"_")[[1]][3]
  setkey(repDT,Barcode)
  DT <- repDT[barcode]
  seLR <- wDT[,list(se=sd(EduPositiveProportionLogitNorm)/sqrt(.N)), by=GeneSymbol]
  DT <- merge(DT,seLR,by="GeneSymbol")
  p <- ggplot(DT, aes(x=factor(relevel(reorder(GeneSymbol, EduPositiveProportionLogitNorm, FUN=median),ref="NegCtrl")), y=EduPositiveProportionLogitNorm))+    
    geom_bar(stat="identity", fill="gray30")+ 
    geom_errorbar(aes(ymax=EduPositiveProportionLogitNorm+se, ymin=EduPositiveProportionLogitNorm-se),position="dodge", width=0.25)+
    #geom_hline(yintercept=1, colour="blue")+
    ggtitle(paste("Edu Positive Proportion (logit) Normalized to NegCtrl in",barcode))+
    xlab("")+ylab("")+
    facet_grid(CellLine~Barcode, scales="free")+
    theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.6)),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  print(p)
}

```

```{r cellCycle}

p <- ggplot(cDT[cDT$GeneSymbol=="NegCtrl"], aes(x=TotalIntensityDAPI, y=log2(MeanIntensityAlexa647+1), colour=CellCycleState))+
  geom_point(size=.1, alpha=.4)+
  guides(colour=FALSE)+
  ggtitle("Cell Cycle States of NegCtrl")+
  geom_rug(col=rgb(.5,0,0,alpha=.01))+
  facet_grid(CellLine~Plate,scales = "free_y", labeller = labeller(Plate = label_both, CellLine = label_value))
print(p)

wCcsDTm <- melt(wDT, id.vars=c("Barcode","Plate","CellLine","Well","GeneSymbol"),measure.vars = c("G0G1Proportion","SProportion","G2Proportion"), variable.name = "State",value.name = "Proportion")

ccsDT <- wCcsDTm[,list(Proportion=mean(Proportion)), by="Barcode,Plate,CellLine,GeneSymbol,State"]

p <- ggplot(ccsDT, aes(x=factor(GeneSymbol), y=Proportion, fill=State))+
  geom_bar(stat="identity")+
  facet_grid(CellLine~Plate,scales = "free_x", labeller = labeller(Plate = label_both, CellLine = label_value))+
  ggtitle("Cell Cycle States")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.5)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.6)),legend.title=element_text(size = rel(.8)))
suppressWarnings(print(p))

#ggplotly(p)

```

```{r datatables}

setkey(repDT, WellCellCountNorm,LineageRatioNorm,EduPositiveProportionLogitNorm)
datatable(format(repDT[,list(CellLine,GeneSymbol,WellCellCountNorm,LineageRatioNorm,EduPositiveProportionLogitNorm,G0G1Proportion,SProportion,G2Proportion)], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = c("Cell Line", "Gene", "WCC", "Lineage Ratio", "EdU+","G0G1","S","G2"))

setkey(wDT, WellCellCountNorm,LineageRatioNorm,EduPositiveProportionLogitNorm)
datatable(format(wDT[,list(CellLine,GeneSymbol,WellCellCountNorm,LineageRatioNorm,EduPositiveProportionLogitNorm,G0G1Proportion,SProportion,G2Proportion,OmeroDetailURL)], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = c("Cell Line", "Gene", "WCC", "Lineage Ratio", "EdU+","G0G1","S","G2","Omero"),escape = FALSE)
```

```{r spectral}

p <- ggplot(cDT[cDT$GeneSymbol=="NegCtrl"], aes(x=log2(MeanIntensityDAPI+1), y=log2(MeanIntensityAlexa488Cyto+1)))+
  geom_point(size=.1)+
  geom_rug(col=rgb(.5,0,0,alpha=.01))+
   ggtitle("KRT5 vs. Mean DAPI in NegCtrl")+
  facet_grid(CellLine~Plate,scales = "free_y",labeller = labeller(Plate = label_both, CellLine = label_value))
print(p)

p <- ggplot(cDT[cDT$GeneSymbol=="NegCtrl"], aes(x=log2(MeanIntensityAlexa488Cyto+1), y=log2(MeanIntensityAlexa555Cyto+1)))+
  geom_point(size=.1)+
  geom_rug(col=rgb(.5,0,0,alpha=.01))+
  ggtitle("KRT19 vs. KRT5 in NegCtrl")+
  facet_grid(CellLine~Plate,scales = "free_y",labeller = labeller(Plate = label_both, CellLine = label_value))
print(p)

p <- ggplot(cDT[cDT$GeneSymbol=="NegCtrl"], aes(x=log2(MeanIntensityAlexa555Cyto+1), y=log2(MeanIntensityAlexa647+1)))+
  geom_point(size=.1)+
  geom_rug(col=rgb(.5,0,0,alpha=.01))+
    ggtitle("EdU vs. KRT19 in NegCtrl")+
  facet_grid(CellLine~Plate,scales = "free_y",labeller = labeller(Plate = label_both, CellLine = label_value))
print(p)

```

```{r controlsAnalysis,  fig.width=8, fig.height=6}

setkey(cDT,GeneSymbol)
DT <- cDT[c("PLK1","NegCtrl")]

#Compute Z' Factors
wccZp <- imageHTS::zprime(DT[GeneSymbol=="NegCtrl",WellCellCount],DT[GeneSymbol=="PLK1",WellCellCount])

calcZPrime <- function(dt, value){
  imageHTS::zprime(DT[GeneSymbol=="NegCtrl",WellCellCount],DT[GeneSymbol=="PLK1",WellCellCount])
}
cat("Well Cell Count Z Prime Factor Values")
for(barcode in unique(DT$Barcode)){
  setkey(DT,Barcode)
  bDT <-DT[barcode]
 cat(unique(bDT$Barcode),unique(bDT$CellLine),"WellCellCount", imageHTS::zprime(bDT[GeneSymbol=="NegCtrl",WellCellCount],bDT[GeneSymbol=="PLK1",WellCellCount], method='original'),"\n")
}

p <- ggplot(DT, aes(x=WellCellCount, fill = GeneSymbol))+
  geom_density(alpha=.5)+   
  #coord_cartesian(xlim())
  ggtitle(paste("Cell Count Controls Density Analysis for Atwaters Plates"))+
  xlab("")+ylab("Nuclei Count Density")+
  facet_grid(CellLine~Plate,scales = "free")+
  theme(strip.text = element_text(size = rel(.5)), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(.8)),legend.text=element_text(size = rel(.6)),legend.title=element_text(size = rel(.6)), strip.text = element_text(size = rel(.4)))
print(p)

```


```{r Heatmaps, echo=FALSE, fig.width=7,fig.height=3, eval=TRUE}

for (barcode in unique(wDT$Barcode)){
  setkey(wDT,Barcode)
  DT <- wDT[barcode]
  
  p <- ggplot(DT, aes(x=Column, y=Row, colour=WellCellCount))+
    geom_point(size=4)+
    ylim(16,1)+
    scale_x_continuous(breaks=c(1:24))+
    scale_colour_gradient(low = "white", high = "red")+
    guides(colour = guide_legend("Well Cell Count", keywidth = .5, keyheight = .5))+
    ggtitle(paste("Well Cell Count for",unique(DT$CellLine), "cells in plate",unique(DT$Barcode)))+
    xlab("")+ylab("")+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(.3)),legend.title=element_text(size = rel(.3)))
  suppressWarnings(print(p))
  
}

```


```{r Layout, echo=FALSE, fig.width=6,fig.height=2, eval=TRUE}

p <- ggplot(wDT, aes(x=Column, y=Row, colour=GeneSymbol))+
  geom_point(size=2)+
  scale_y_reverse(breaks=c(16:1))+
  scale_x_continuous(breaks=c(1:24))+
  guides(colour=FALSE)+
  ggtitle(paste("Well Plate Layout"))+
  xlab("")+ylab("")+
  facet_wrap(~Plate)
print(p)

```


